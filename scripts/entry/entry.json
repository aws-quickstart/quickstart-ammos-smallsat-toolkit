{"AWSTemplateFormatVersion": "2010-09-09", "Parameters": {"ProjectName": {"Type": "String"}, "QSS3BucketName": {"Type": "String", "Default": "aws_quickstart"}, "QSS3KeyPrefix": {"Type": "String", "Default": "quickstart-ammos-smallsat-toolkit/"}, "QSS3BucketRegion": {"Type": "String", "Default": ""}, "MainStackParams": {"Type": "String"}, "RolePath": {"Type": "String", "Default": ""}, "PermissionsBoundaryArn": {"Type": "String", "Default": ""}, "DeployIam": {"Type": "String", "Default": "true"}}, "Conditions": {"DeployIam": {"Fn::Equals": [{"Ref": "DeployIam"}, "true"]}, "RolePathProvided": {"Fn::Not": [{"Fn::Equals": ["", {"Ref": "RolePath"}]}]}, "UsingDefaultBucket": {"Fn::Equals": [{"Ref": "QSS3BucketName"}, "aws-quickstart"]}, "PermissionsBoundaryProvided": {"Fn::Not": [{"Fn::Equals": ["", {"Ref": "PermissionsBoundaryArn"}]}]}}, "Resources": {"ConfigParserRole": {"Type": "AWS::IAM::Role", "Condition": "DeployIam", "Properties": {"RoleName": {"Fn::Sub": "${ProjectName}-ConfigParser"}, "AssumeRolePolicyDocument": {"Statement": [{"Action": "sts:AssumeRole", "Effect": "Allow", "Principal": {"Service": "lambda.amazonaws.com"}}], "Version": "2012-10-17"}, "ManagedPolicyArns": [{"Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"}], "Path": {"Fn::If": ["RolePathProvided", {"Ref": "RolePath"}, {"Ref": "AWS::NoValue"}]}, "PermissionsBoundary": {"Fn::If": ["PermissionsBoundaryProvided", {"Ref": "PermissionsBoundaryArn"}, {"Ref": "AWS::NoValue"}]}}}, "ConfigParser": {"Type": "AWS::Lambda::Function", "Properties": {"FunctionName": {"Fn::Sub": "${ProjectName}-ConfigParser"}, "Handler": "config_parser.handler", "MemorySize": 256, "Timeout": 300, "Role": {"Fn::Join": ["", [{"Fn::Sub": "arn:${AWS::Partition}:iam::${AWS::AccountId}:role"}, {"Fn::If": ["RolePathProvided", {"Ref": "RolePath"}, "/"]}, {"Fn::Sub": "${ProjectName}-ConfigParser"}]]}, "Runtime": "python3.9", "Code": {"S3Bucket": {"Fn::If": ["UsingDefaultBucket", {"Fn::Sub": "${QSS3BucketName}-${AWS::Region}"}, {"Ref": "QSS3BucketName"}]}, "S3Key": {"Fn::Sub": "${QSS3KeyPrefix}functions/packages/ConfigParser/lambda.zip"}}}, "DependsOn": "ConfigParserRole"}, "Config": {"Type": "AWS::CloudFormation::CustomResource", "Properties": {"ServiceToken": {"Fn::GetAtt": ["ConfigParser", "Arn"]}, "MainStackParams": {"Ref": "MainStackParams"}}}, "MainStack": {"Type": "AWS::CloudFormation::Stack", "Properties": {"TemplateURL": {"Fn::Sub": ["https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/ammos-cubs.main.template.yaml", {"S3Region": {"Fn::If": ["UsingDefaultBucket", {"Ref": "AWS::Region"}, {"Ref": "QSS3BucketRegion"}]}, "S3Bucket": {"Fn::If": ["UsingDefaultBucket", {"Fn::Sub": "${QSS3BucketName}-${AWS::Region}"}, {"Ref": "QSS3BucketName"}]}}]}, "Parameters": {"AITInstanceType": {"Fn::GetAtt": ["Config", "AITInstanceType"]}, "CloudWatchLogsRetentionPeriod": {"Fn::GetAtt": ["Config", "CloudWatchLogsRetentionPeriod"]}, "KeyPairName": {"Fn::GetAtt": ["Config", "KeyPairName"]}, "VPCCIDR": {"Fn::GetAtt": ["Config", "VPCCIDR"]}, "PublicSubnet1CIDR": {"Fn::GetAtt": ["Config", "PublicSubnet1CIDR"]}, "PublicSubnet2CIDR": {"Fn::GetAtt": ["Config", "PublicSubnet2CIDR"]}, "PublicSubnet3CIDR": {"Fn::GetAtt": ["Config", "PublicSubnet3CIDR"]}, "PrivateSubnet1CIDR": {"Fn::GetAtt": ["Config", "PrivateSubnet1CIDR"]}, "PrivateSubnet2CIDR": {"Fn::GetAtt": ["Config", "PrivateSubnet2CIDR"]}, "PrivateSubnet3CIDR": {"Fn::GetAtt": ["Config", "PrivateSubnet3CIDR"]}, "AvailabilityZones": {"Fn::GetAtt": ["Config", "AvailabilityZones"]}, "QSS3BucketName": {"Fn::GetAtt": ["Config", "QSS3BucketName"]}, "QSS3BucketRegion": {"Fn::GetAtt": ["Config", "QSS3BucketRegion"]}, "QSS3KeyPrefix": {"Fn::GetAtt": ["Config", "QSS3KeyPrefix"]}, "RemoteAccessCIDR": {"Fn::GetAtt": ["Config", "RemoteAccessCIDR"]}, "SSLCertificateArn": {"Fn::GetAtt": ["Config", "SSLCertificateArn"]}, "HostedZoneID": {"Fn::GetAtt": ["Config", "HostedZoneID"]}, "FQDN": {"Fn::GetAtt": ["Config", "FQDN"]}, "PermissionsBoundaryArn": {"Fn::GetAtt": ["Config", "PermissionsBoundaryArn"]}, "RolePath": {"Fn::GetAtt": ["Config", "RolePath"]}, "ProjectName": {"Fn::GetAtt": ["Config", "ProjectName"]}, "VpcId": {"Fn::GetAtt": ["Config", "VpcId"]}, "PublicSubnet1ID": {"Fn::GetAtt": ["Config", "PublicSubnet1ID"]}, "PublicSubnet2ID": {"Fn::GetAtt": ["Config", "PublicSubnet2ID"]}, "PrivateSubnet1AID": {"Fn::GetAtt": ["Config", "PrivateSubnet1AID"]}, "PrivateSubnet2AID": {"Fn::GetAtt": ["Config", "PrivateSubnet2AID"]}, "PrivateSubnet3AID": {"Fn::GetAtt": ["Config", "PrivateSubnet3AID"]}, "AccessSgID": {"Fn::GetAtt": ["Config", "AccessSgID"]}, "DeployIam": {"Fn::GetAtt": ["Config", "DeployIam"]}}}}}}