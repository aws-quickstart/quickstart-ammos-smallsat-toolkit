Parameters:
  ProjectName:
    Description: Name of your project
    Type: String
  # TODO: Enforce AllowedValues
  RolePath:
    Description: Will be attached to all created IAM Roles to satisfy security requirements.
    Type: String
  # TODO: Enforce AllowedValues
  PermissionsBoundaryArn:
    Description: Will be attached to all created IAM Roles to satisfy security requirements.
    Type: String

Conditions:
  RolePathProvided: !Not [!Equals ['', !Ref RolePath]]
  PermissionsBoundaryProvided: !Not [!Equals ['', !Ref PermissionsBoundaryArn]]

Resources:
  ConfigBucket:
    DeletionPolicy: Retain
    Type: AWS::S3::Bucket
    UpdateReplacePolicy: Retain
  BucketSeedFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket: ammos-cubs-assets
        S3Key: bucket-seed-function.zip
      Handler: cfn_cognito_inspect.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Runtime: python3.8
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      Path: !If [RolePathProvided, !Ref RolePath, !Ref AWS::NoValue]
      PermissionsBoundary:  !If [PermissionsBoundaryProvided, !Ref PermissionsBoundaryArn, !Ref AWS::NoValue]
      Policies:
        - PolicyDocument:
            Statement:
              - Action: s3:PutObject
                Effect: Allow
                Resource:
                  - !Sub 'arn:${AWS::Partition}:s3:::${ConfigBucket}/*'
            Version: "2012-10-17"
          PolicyName: config-bucket-put-objects
  SeedBucket:
    Type: AWS::CloudFormation::CustomResource
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      ServiceToken: !Ref BucketSeedFunction

Outputs:
  ExportsOutputRefConfigBucket2112C5EC685752CB:
    Export:
      Name: !Sub "${ProjectName}-ConfigBucketName"
    Value: !Ref ConfigBucket
